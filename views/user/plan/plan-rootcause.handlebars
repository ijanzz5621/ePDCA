<link rel="stylesheet" href="/css/plan/plan.css" />
<link rel="stylesheet" href="/css/plan-root-cause.css" />

<h3>Plan Root Cause</h3>

<div class="row" id="rootcauseHeader">
    <div class="col-md-12">
        <span style="font-size:18px;">Problem Statement</span>
        <br/>
        <div style="background:#f0f0f0; height:65px; padding:5px; border:3px dashed #c3c1c1; border-radius:6px; margin-top:5px; margin-bottom:5px; vertical-align:middle;">
            <span id="probstate" style="font-size:14px;">
            </span>
        </div>
    </div>
</div>

<div id="divlist">

    <div class="row" style="margin-top:15px;">

        <div class="col-md-12">
            <span style="font-size:18px;">Root Cause list</span>
        </div>

    </div>

    <div class="row" >

        <div class="col-md-12" style="">
            <img id="add" src="/img/add-icon.png" width="35" title="add new root cause" style="cursor:pointer;" />        
            &nbsp;
            <img id="back" src="/img/back.png" width="35" title="back to root cause list" style="cursor:pointer;display:none;" />
        </div>

        <div class="col-md-12">
            <ul id="list">
            </ul>
        </div>
    </div>

    <div class="row">
        <div id="details" style="display:none;" class="col-md-12">

            <span style="font-size:18px; text-align:center; margin: 0 auto;"> Is this an actual root cause? </span>
            <br/><br/>
            <div class="funkyradio">
                <div class="funkyradio-success">
                    <input type="radio" name="radioActualRootCause" value="Yes" id="follow-std-yes" />
                    <label for="follow-std-yes">Yes</label>
                </div>
                <div class="funkyradio-success">
                    <input type="radio" name="radioActualRootCause" value="No" id="follow-std-no" />
                    <label for="follow-std-no">No</label>
                </div>
            </div>

        </div>
    </div>

</div>

<div id="divwhylist" style="margin-top:15px;display:none;">

    <div class="col-md-12" style="">
        <img id="addwhy" src="/img/add-icon.png" width="35" title="add new why" style="cursor:pointer;" />        
        &nbsp;
        <img id="backwhy" src="/img/back.png" width="35" title="back to why list" style="cursor:pointer;display:none;" />
    </div>

    <div class="col-md-12">
        <span style="font-size:18px;">Why List</span>
    </div>

    <div class="row">

        <div class="col-md-12">

            <ul id="whylist">
            </ul>

        </div>

    </div>

    <div class="row">
        <div class="col-md-8 col-md-push-2">

            <ul id="divcommentlist" style="display:none; background:#fcfcfc; padding:30px; 
            border:1px solid #c3c1c1; border-radius:6px;height:300px; overflow:scroll; list-style:none;">

                <li>
                    <div class="chat-line" style="text-align:right;">
                        <div class="chat-icon" style="display:inline-block">
                            <img src="/img/user-icon-man-64.png" style="width:48px; padding:5px; display:inline-block" />
                            <span style="display:inline-block">Sharizan</span>
                        </div>
                        <br/>
                        <span class="comment-datetime" style="display:inline-block">2017-09-16 15:00</span>
                        <div class="chat-content" style="display:block">
                            Supervisor are busy with Audit which will happened on the following week
                        </div>
                    </div>
                </li>
                <li>
                    <div class="chat-line">
                        <div class="chat-icon" style="display:inline-block">
                            <img src="/img/user-icon-lady-64.png" style="width:48px; padding:5px; display:inline-block" />
                            <span style="display:inline-block">Diana</span>
                        </div>
                        <br/>
                        <span class="comment-datetime" style="display:inline-block">2017-09-16 15:00</span>
                        <div class="chat-content" style="display:block">
                            Someone must really take this seriously. If not we will loose an important customer.
                        </div>
                    </div>
                </li>
                <li>
                    <div class="chat-line">
                        <div class="chat-icon" style="display:inline-block">
                            <img src="/img/user-icon-man-64.png" style="width:48px; padding:5px; display:inline-block" />
                            <span style="display:inline-block">Azhar</span>
                        </div>
                        <br/>
                        <span class="comment-datetime" style="display:inline-block">2017-09-16 15:00</span>
                        <div class="chat-content" style="display:block">
                            Agree with Diana.
                        </div>
                    </div>
                </li>
                <li>
                    <div class="chat-line" style="text-align:right;">
                        <div class="chat-icon" style="display:inline-block">
                            <img src="/img/user-icon-man-64.png" style="width:48px; padding:5px; display:inline-block" />
                            <span style="display:inline-block">Sharizan</span>
                        </div>
                        <br/>
                        <span class="comment-datetime" style="display:inline-block">2017-09-16 15:00</span>
                        <div class="chat-content" style="display:block">
                            I will discuss with all team leader and supervisor as soon as possible.
                        </div>
                    </div>
                </li>


                

                

                

                

            </ul>

        </div>
    </div>

    <div class="row">
        <div class="col-md-8 col-md-push-2">

            <div id="commentBox" style="display:none;">
                <form class="msform" style="margin:0; margin-top:15px; padding:0;">
                    <label style="text-align:left; align-self:flex-start !important; font-size:14px !important;">Enter your comment here:</label>
                    <input type="text" id="txtComment" />
                </form>
            </div>

        </div>
    </div>

</div>

{{> plan/plan-new-rootcause}}
{{> plan/plan-new-why}}

<script src="/js/plan/li-builder.js"></script>
<script src="/js/plan/modal-generator.js"></script>
<script>

    var _planID = getUrlParameter("planID");
    var gRootcauseID = "";

    $(document).ready(function(){

        //load data and append list 
        var data = { planID: _planID }; 
        var request = callAjax2('/api/plan-get-plandetails', data);
        request.done(function(result){
            $('#probstate').html(result[0].ProbStatement)
        });
        request.fail(function(jqXHR, textStatus) {
            alert( "Request failed: " + textStatus );
        });

        var request2 = callAjax2('/api/plan-get-rootcause', data);
        request2.done(function(result){
            $.each(result, function(key, val){
                $(liPlanRootCauseList(val.RecGuid, val.Username, val.Gender, val.Title, val.CreatedOn, val.CurrentStatus, 15))
                .delay(100)
                .appendTo('#list')
                .hide()
                .slideDown('slow');
            });
        });
        request2.fail(function(jqXHR, textStatus) {
            alert( "Request failed: " + textStatus );
        });

        $(document).on('click', '#add', function (e) {
            $('#modal-plan-new-rootcause').modal();
            //focus
            setTimeout(function(){
                $('#modal-plan-addrootcause-txtTitle').focus();
            }, 1000);
        });
        //add why
        $(document).on('click', '#addwhy', function (e) {
            $('#modal-plan-new-why').modal();
            //focus
            setTimeout(function(){
                $('#modal-plan-addwhy-txtWhy').focus();
            }, 1000);
        });

        //save new root cause
        $(document).on('click', '#modal-plan-addrootcause-btnSubmit', function(e){
            e.preventDefault();
            var data = { 
                planID: _planID
                , title: $('#modal-plan-addrootcause-txtTitle').val() 
                , desc: $('#modal-plan-addrootcause-txtDesc').val()
            };

            //call ajax to save
            var result = callAjax('/api/plan-add-rootcause', data);
            $(liPlanRootCauseList(result[0][0].recGuid, result[0][0].username, result[0][0].gender, 
                $('#modal-plan-addrootcause-txtTitle').val(), 
                result[0][0].createdOn, "NEW", 15))
            .delay(100)
            .appendTo('#list')
            .hide()
            .slideDown('slow');

            //close modal
            $('#modal-plan-new-rootcause').modal('toggle');

        });

        //save new why
        $(document).on('click', '#modal-plan-addwhy-btnSubmit', function(e){
            e.preventDefault();
            var data = { 
                planID: _planID
                , rootcauseID: gRootcauseID 
                , why: $('#modal-plan-addwhy-txtWhy').val() 
            };

            //call ajax to save
            var result = callAjax('/api/plan-add-why', data);
            $(liPlanRootCauseWhyList(result[0][0].recGuid, result[0][0].username, result[0][0].gender, 
                $('#modal-plan-addwhy-txtWhy').val(), result[0][0].createdOn, "NEW", 0))
                .delay(100)
                .appendTo('#whylist')
                .hide()
                .slideDown('slow');

            //close modal
            $('#modal-plan-new-why').modal('toggle');

        });

        //add comment
        $(document).on('keypress', '#txtComment', function(e){
            if (e.keyCode === 13 && $(this).val().trim() !== ""){
                e.preventDefault();
                //$('#divcommentlist').append("<li>" + $(this).val() + "</li>")
                
                $(liComment("Sharizan", "sharizan_81@yahoo.com", "test@test.com", "M", $(this).val()))
                    .appendTo("#divcommentlist")
                ;
                
                $("#divcommentlist").animate({ scrollTop: $('#divcommentlist').prop("scrollHeight")}, 1000);
                $(this).val("");
                $(this).focus();
            }
        });

    });

    function viewWhyList(obj, rootcauseId){

        gRootcauseID = rootcauseId;

        if ($(obj).closest('.li-rootcause').hasClass("selected-rootcause")){

            $('#whylist').html("");
            $('#divcommentlist').html("");
            $('#divcommentlist').hide('slow');
            $('#commentBox').hide();

            $(obj).closest('.li-rootcause').siblings().show('slow');
            $('.li-rootcause .liFooter .footer-item-right > li > span').removeClass("li-active");
            $('#rootcauseHeader').show('slow');

            $(obj).closest('.li-rootcause').removeClass("selected-rootcause");
            $('#divwhylist').hide('slow');
        } else {

            $(obj).closest('.li-rootcause').siblings().hide('slow');
            $('.li-rootcause .liFooter .footer-item-right > li > span').removeClass("li-active");
            $(obj).addClass("li-active");
            $('#rootcauseHeader').hide('slow');

            $(obj).closest('.li-rootcause').addClass("selected-rootcause");
            $('#divwhylist').show('slow');

            //Call ajax to load why list
            var rootcauseData = { rootcauseId: rootcauseId };
            var whyList = callAjax('/api/plan-rootcause-get_whylist', rootcauseData);

            $.each(whyList, function(key, val){
                $(liPlanRootCauseWhyList(val.RecGuid, val.Username, val.Gender, val.Why, val.CreatedOn, val.CurrentStatus, 0))
                .delay(100)
                .appendTo('#whylist')
                .hide()
                .slideDown('slow');
            });
        }
    }

    function viewCommentList(obj, whyGuid){
        if ($(obj).closest('.li-why').hasClass("selected-why")){
            $(obj).closest('.li-why').siblings().show('slow');
            $('.li-why .liFooter .footer-item-right > li > span').removeClass("li-active");

            $(obj).closest('.li-why').removeClass("selected-why");
            $('#divcommentlist').html("");
            $('#divcommentlist').hide('slow');
            $('#commentBox').hide();
            $('#txtComment').val("");

            $('#divlist').show('slow');
        } else {

            $(obj).closest('.li-why').siblings().hide('slow');
            $('.li-why .liFooter .footer-item-right > li > span').removeClass("li-active");
            $(obj).addClass("li-active");

            $(obj).closest('.li-why').addClass("selected-why");
            $('#divcommentlist').show('slow');
            $('#commentBox').show();

            $("#divcommentlist").animate({ scrollTop: $('#divcommentlist').prop("scrollHeight")}, 1000);
            setTimeout(function(){
                $('#txtComment').focus();
            }, 500);

            $('#divlist').hide('slow');

            //Call ajax to load comment list
        }
    }

</script>